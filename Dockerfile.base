# syntax=docker/dockerfile:1.4

#############################
# ðŸ›  Builder Stage
#############################
FROM python:3.12-alpine AS builder

WORKDIR /app

# Accept build argument for Poetry groups
ARG POETRY_GROUPS="main"
ARG IS_PROD="true"

# Install build-time dependencies
RUN apk add --no-cache \
    build-base libffi-dev openssl-dev \
    curl wget git

# Install Poetry
RUN pip install --no-cache-dir poetry

# Prevent Poetry from creating venvs
ENV POETRY_VIRTUALENVS_CREATE=false \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app

# Copy dependency definitions
COPY pyproject.toml poetry.lock README.md ./

# Install dependencies based on environment
RUN if [ "$IS_PROD" = "true" ]; then \
        poetry install --only main,${POETRY_GROUPS} --no-root --no-interaction --no-ansi; \
    else \
        poetry install --only main,${POETRY_GROUPS},debug --no-root --no-interaction --no-ansi; \
    fi


#############################
# ðŸš€ Runtime Stage
#############################
FROM python:3.12-alpine

WORKDIR /app

# Install only runtime system libraries
RUN apk add --no-cache \
    libffi \
    openssl

ENV PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app

# Copy installed Python packages and entrypoints
COPY --from=builder /usr/local/lib/python3.12 /usr/local/lib/python3.12
COPY --from=builder /usr/local/bin /usr/local/bin

# Copy app source
# COPY ./src/mcp_servers /app/mcp_servers

# (Optional) create runtime dirs
RUN mkdir -p /app/files/downloads /app/screenshots

CMD ["python", "--version"]
